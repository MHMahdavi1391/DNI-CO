<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø±Ú©Ø² Ø±ÙˆØ§Ù†â€ŒØ¯Ø±Ù…Ø§Ù†ÛŒ Ùˆ Ù†ÙˆØ±ÙˆØªØ±Ø§Ù¾ÛŒ Ø¯Ú©ØªØ± Ù¾Ú˜Ù…Ø§Ù†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: Tahoma, sans-serif;
      margin: 0;
      padding: 0;
      direction: rtl;
      background-color: #e0f7fa;
    }
    header {
      background-color: #00bcd4;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; }

    .top-buttons {
      display: flex;
      gap: 10px;
    }

    .top-button {
      width: 40px;
      height: 40px;
      background-color: #ffffff33;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .top-button:hover { background-color: #ffffff66; }

    main {
      display: none;
      padding: 10px;
      gap: 10px;
    }
    main.active {
      display: flex;
    }
    .column {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    #patientListColumn { width: 25%; }
    #centerColumn { width: 50%; }
    #addPatientColumn { width: 25%; }

    label, input, textarea, select, button {
      display: block;
      width: 100%;
      margin: 8px 0;
      font-size: 16px;
    }
    input, textarea, select {
      padding: 6px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      padding: 8px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #388e3c;
    }
    .danger {
      background-color: #e53935 !important;
    }
    .danger:hover {
      background-color: #c62828 !important;
    }
    .hidden { display: none; }

    .appointment-entry {
      border-bottom: 1px solid #ccc;
      padding: 6px 0;
    }
    .appointment-entry span {
      display: inline-block;
      margin-left: 10px;
    }

    .patient-name {
      font-weight: bold;
      font-size: 18px;
      margin-top: 10px;
    }
    .patient-info {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .refresh-button {
      margin-top: 8px;
      background-color: #03a9f4;
    }
    .refresh-button:hover {
      background-color: #0288d1;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø®Ø±ÙˆØ¬ÛŒ */
    #exportPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 400px;
      max-height: 70vh;
      overflow-y: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      transform: translate(-50%, -50%);
      padding: 15px;
      z-index: 1000;
    }
    #exportPopup.hidden {
      display: none;
    }
    #exportPopup label {
      display: block;
      margin: 5px 0;
    }
    #exportPopup .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #exportPopup .popup-header button {
      background-color: #e53935;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      padding: 3px 8px;
    }
  </style>
</head>
<body>
<header>
    <h1>Ù…Ø±Ú©Ø² Ø±ÙˆØ§Ù†â€ŒØ¯Ø±Ù…Ø§Ù†ÛŒ Ùˆ Ù†ÙˆØ±ÙˆØªØ±Ø§Ù¾ÛŒ Ø¯Ú©ØªØ± Ù¾Ú˜Ù…Ø§Ù†</h1>
    <div class="top-buttons">
      <button class="top-button" onclick="showPage('main')">ğŸ“–</button>
      <button class="top-button" onclick="showPage('stats')">ğŸ“Š</button>
    </div>
  </header>

  <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
  <main id="mainView" class="active">
    <div id="patientListColumn" class="column">
      <h3>Ù„ÛŒØ³Øª Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†</h3>
      <input type="text" id="searchPatient" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨ÛŒÙ…Ø§Ø±..." oninput="renderPatients()" />
      <button class="refresh-button" onclick="renderPatients()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
      <div id="patientList"></div>
    </div>

    <div id="centerColumn" class="column">
      <h3>Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h3>
      <div style="display:flex; gap: 10px; margin-bottom: 10px;">
        <input type="number" id="searchDateYear" placeholder="Ø³Ø§Ù„ (Ø´Ù…Ø³ÛŒ)" min="1300" max="1500" style="width: 30%;" />
        <input type="number" id="searchDateMonth" placeholder="Ù…Ø§Ù‡ (Ø´Ù…Ø³ÛŒ)" min="1" max="12" style="width: 30%;" />
        <input type="number" id="searchDateDay" placeholder="Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ)" min="1" max="31" style="width: 30%;" />
        <button class="refresh-button" onclick="showAppointments()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
      </div>
      <div id="appointmentList"></div>
    </div>

    <div id="addPatientColumn" class="column">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯</h3>
      <input type="text" id="patientName" placeholder="Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±" />
      <input type="text" id="patientFather" placeholder="Ù†Ø§Ù… Ù¾Ø¯Ø±" />
      <input type="text" id="patientPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Û±" />
      <input type="text" id="patientPhone2" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Û²" />
      <div style="display:flex; gap: 5px;">
        <input type="number" id="patientRegisterYear" placeholder="Ø³Ø§Ù„ Ø«Ø¨Øª (Ø´Ù…Ø³ÛŒ)" min="1300" max="1500" style="width: 33%;" />
        <input type="number" id="patientRegisterMonth" placeholder="Ù…Ø§Ù‡ Ø«Ø¨Øª (Ø´Ù…Ø³ÛŒ)" min="1" max="12" style="width: 33%;" />
        <input type="number" id="patientRegisterDay" placeholder="Ø±ÙˆØ² Ø«Ø¨Øª (Ø´Ù…Ø³ÛŒ)" min="1" max="31" style="width: 33%;" />
      </div>
      <button onclick="addPatient()">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
    </div>
  </main>

  <main id="statsView">
    <div class="column" style="width: 25%">
      <h3>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†</h3>
      <input type="text" id="statsSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨ÛŒÙ…Ø§Ø±..." oninput="renderStatsPatients()" />
      <button class="refresh-button" onclick="renderStatsPatients()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
      <label><input type="checkbox" id="selectAllPatients" onchange="toggleAllPatients(this)"> Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡</label>
      <div id="statsPatients"></div>
    </div>

    <div class="column" style="width: 50%">
      <h3>Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</h3>
      <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
      <div style="display:flex; gap: 5px; margin-bottom: 10px;">
        <input type="number" id="fromYear" placeholder="Ø³Ø§Ù„ (Ø´Ù…Ø³ÛŒ)" min="1300" max="1500" style="width: 33%;" />
        <input type="number" id="fromMonth" placeholder="Ù…Ø§Ù‡ (Ø´Ù…Ø³ÛŒ)" min="1" max="12" style="width: 33%;" />
        <input type="number" id="fromDay" placeholder="Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ)" min="1" max="31" style="width: 33%;" />
      </div>
      <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
      <div style="display:flex; gap: 5px; margin-bottom: 10px;">
        <input type="number" id="toYear" placeholder="Ø³Ø§Ù„ (Ø´Ù…Ø³ÛŒ)" min="1300" max="1500" style="width: 33%;" />
        <input type="number" id="toMonth" placeholder="Ù…Ø§Ù‡ (Ø´Ù…Ø³ÛŒ)" min="1" max="12" style="width: 33%;" />
        <input type="number" id="toDay" placeholder="Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ)" min="1" max="31" style="width: 33%;" />
      </div>
      <button onclick="calculateStats()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
      <div id="results"></div>
    </div>

    <div class="column" style="width: 25%">
      <h3>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3>
      <button onclick="downloadBackup()">ğŸ“¥ Ø¨Ú©Ø§Ù¾ Ú¯Ø±ÙØªÙ†</button>
      <button onclick="uploadBackup()">ğŸ“¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ú©Ø§Ù¾</button>
      <button class="danger" onclick="deleteAllData()">ğŸ—‘ï¸ Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
      <br /><br />
      <button onclick="openExportPopup()">ğŸ“„ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†</button>
    </div>
  </main>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† -->
  <div id="exportPopup" class="hidden">
    <div class="popup-header">
      <h3>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ</h3>
      <button onclick="closeExportPopup()">âœ–</button>
    </div>
    <input type="text" id="exportSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†..." oninput="renderExportPatients()" />
    <label><input type="checkbox" onchange="toggleAllExportPatients(this)"> Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡</label>
    <div id="exportPatientList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-top: 5px;"></div>
    <button style="margin-top: 10px;" onclick="generateTXT()">â¬‡ Ø®Ø±ÙˆØ¬ÛŒ ÙØ§ÛŒÙ„ Ù…ØªÙ†ÛŒ (TXT)</button>
  </div>
a<script>
  let patients = JSON.parse(localStorage.getItem("patients")) || [];
  let appointments = JSON.parse(localStorage.getItem("appointments")) || [];

  function saveData() {
    localStorage.setItem("patients", JSON.stringify(patients));
    localStorage.setItem("appointments", JSON.stringify(appointments));
  }

  function showPage(id) {
    document.querySelectorAll("main").forEach(m => m.classList.remove("active"));
    document.getElementById(id + "View").classList.add("active");
  }

  // Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯
  function addPatient() {
    const name = document.getElementById("patientName").value.trim();
    const father = document.getElementById("patientFather").value.trim();
    const phone = document.getElementById("patientPhone").value.trim();
    const phone2 = document.getElementById("patientPhone2").value.trim();
    const year = document.getElementById("patientRegisterYear").value.trim();
    const month = document.getElementById("patientRegisterMonth").value.trim();
    const day = document.getElementById("patientRegisterDay").value.trim();

    if (!name || !father || !phone || !phone2 || !year || !month || !day) {
      alert("Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯");
      return;
    }
    const regDate = `${year.padStart(4, '0')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    const patient = { id: Date.now(), name, father, phone, phone2, regDate };
    patients.push(patient);
    saveData();
    renderPatients();
    clearPatientForm();
  }

  function clearPatientForm() {
    document.getElementById("patientName").value = "";
    document.getElementById("patientFather").value = "";
    document.getElementById("patientPhone").value = "";
    document.getElementById("patientPhone2").value = "";
    document.getElementById("patientRegisterYear").value = "";
    document.getElementById("patientRegisterMonth").value = "";
    document.getElementById("patientRegisterDay").value = "";
  }

  // Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ø¨Ø§ Ø¬Ø³ØªØ¬Ùˆ
  function renderPatients() {
    const list = document.getElementById("patientList");
    const search = document.getElementById("searchPatient").value.trim();
    list.innerHTML = "";
    patients.filter(p => p.name.includes(search)).forEach(p => {
      const div = document.createElement("div");
      div.innerHTML = `
        <div class="patient-name">${p.name}</div>
        <div class="patient-info">
          Ù¾Ø¯Ø±: ${p.father}<br>
          ğŸ“ ${p.phone} / ${p.phone2}<br>
          ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: ${p.regDate}
        </div>
        <button onclick="createAppointment(${p.id})">ğŸ—“ Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ ÙÙˆØ±ÛŒ</button>
        <button onclick="editPatient(${p.id})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
        <button class="danger" onclick="deletePatient(${p.id})">ğŸ—‘ Ø­Ø°Ù</button>
      `;
      list.appendChild(div);
    });
  }

  // Ø­Ø°Ù Ø¨ÛŒÙ…Ø§Ø± Ùˆ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡
  function deletePatient(id) {
    if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    patients = patients.filter(p => p.id !== id);
    appointments = appointments.filter(a => a.patientId !== id);
    saveData();
    renderPatients();
    showAppointments();
  }

  // ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨ÛŒÙ…Ø§Ø± (Ø§Ø² Ø·Ø±ÛŒÙ‚ ÙØ±Ù… Ø³Ø§Ø¯Ù‡ prompt)
  function editPatient(id) {
    const p = patients.find(x => x.id === id);
    if (!p) return;
    const name = prompt("Ù†Ø§Ù…ØŸ", p.name);
    const father = prompt("Ù†Ø§Ù… Ù¾Ø¯Ø±ØŸ", p.father);
    const phone = prompt("ØªÙ„ÙÙ† Ø§ÙˆÙ„ØŸ", p.phone);
    const phone2 = prompt("ØªÙ„ÙÙ† Ø¯ÙˆÙ…ØŸ", p.phone2);

    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¨Ù‡ Ø§Ø¬Ø²Ø§ÛŒ Ø¬Ø¯Ø§
    const [year, month, day] = p.regDate.split("-");

    const yearNew = prompt("Ø³Ø§Ù„ Ø«Ø¨Øª (Ø´Ù…Ø³ÛŒ)ØŸ", year);
    const monthNew = prompt("Ù…Ø§Ù‡ Ø«Ø¨Øª (Ø´Ù…Ø³ÛŒ)ØŸ", month);
    const dayNew = prompt("Ø±ÙˆØ² Ø«Ø¨Øª (Ø´Ù…Ø³ÛŒ)ØŸ", day);

    if (!name || !father || !phone || !phone2 || !yearNew || !monthNew || !dayNew) return;

    p.name = name;
    p.father = father;
    p.phone = phone;
    p.phone2 = phone2;
    p.regDate = `${yearNew.padStart(4, '0')}-${monthNew.padStart(2, '0')}-${dayNew.padStart(2, '0')}`;

    saveData();
    renderPatients();
  }

  // Ø³Ø§Ø®Øª Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯
  function createAppointment(patientId) {
    const service = prompt("Ù†Ø§Ù… Ø³Ø±ÙˆÛŒØ³ØŸ");
    if (!service) return alert("Ù†Ø§Ù… Ø³Ø±ÙˆÛŒØ³ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");

    const price = prompt("Ù‡Ø²ÛŒÙ†Ù‡ØŸ");
    if (!price || isNaN(price)) return alert("Ù‚ÛŒÙ…Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");

    const method = prompt("Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®ØªØŸ (1. Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†ØŒ 2. Ù†Ù‚Ø¯ÛŒØŒ 3. Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª)");
    let methodStr = "";
    if (method === "1") methodStr = "Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†";
    else if (method === "2") methodStr = "Ù†Ù‚Ø¯ÛŒ";
    else if (method === "3") methodStr = "Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª";
    else return alert("Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");

    // Ù¾ÛŒØ´ÙØ±Ø¶ ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø´Ù…Ø³ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ø´ØªÙ‡ yyyy-mm-dd Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
    const today = new Date();
    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ â€” ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡
    // Ú†ÙˆÙ† Ù…ÛŒØ®ÙˆØ§ÛŒÙ… Ù‡Ù…Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø´Ù…Ø³ÛŒ Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø§Ø´Ù‡ØŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÛŒÚ© Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø´Ù…Ø³ÛŒ Ù…Ø«Ù„ persian-date Ù…Ù†Ø·Ù‚ÛŒ Ø§Ø³Øª
    // ÙˆÙ„ÛŒ Ú†ÙˆÙ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ø¨ÙˆØ¯ Ø§Ø² Ú©ÛŒØª ØªØ§Ø±ÛŒØ® Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø´ÙˆØ¯ØŒ Ù¾Ø³ Ø¨Ø§ÛŒØ¯ ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù†ÙˆÛŒØ³ÛŒÙ… ÛŒØ§ Ø¨Ù‡ Ø³Ø§Ø¯Ù‡ ØªØ±ÛŒÙ† Ø´Ú©Ù„:
    // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ù…Ø±ÙˆØ² Ø±Ø§ Ø«Ø§Ø¨Øª Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ùˆ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ… Ø±Ø´ØªÙ‡ Ø«Ø§Ø¨Øª ÛŒØ§ ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±

    // Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾ÛŒÚ†ÛŒØ¯Ú¯ÛŒØŒ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³Ù‡ Ø¹Ø¯Ø¯ Ø¬Ø¯Ø§ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
    let year = prompt("Ø³Ø§Ù„ (Ø´Ù…Ø³ÛŒ) Ù¾ÛŒØ´ÙØ±Ø¶:", "1404");
    let month = prompt("Ù…Ø§Ù‡ (Ø´Ù…Ø³ÛŒ) Ù¾ÛŒØ´ÙØ±Ø¶:", "04");
    let day = prompt("Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ) Ù¾ÛŒØ´ÙØ±Ø¶:", "21");

    if (!year || !month || !day) return alert("ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");

    const date = `${year.padStart(4,'0')}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;

    const time = prompt("Ø³Ø§Ø¹ØªØŸ (Ù…Ø«Ù„Ø§Ù‹ 14:30)");
    if (!time) return alert("Ø³Ø§Ø¹Øª ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");

    appointments.push({
      id: Date.now(),
      patientId,
      date,
      time,
      service,
      price,
      method: methodStr
    });
    saveData();
    showAppointments();
  }

  // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (Ø³Ø§Ù„ØŒ Ù…Ø§Ù‡ØŒ Ø±ÙˆØ²)
  function showAppointments() {
    const list = document.getElementById("appointmentList");
    list.innerHTML = "";

    const year = document.getElementById("searchDateYear").value.trim();
    const month = document.getElementById("searchDateMonth").value.trim();
    const day = document.getElementById("searchDateDay").value.trim();

    if (!year || !month || !day) {
      list.innerHTML = "<p>Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>";
      return;
    }

    const filterDate = `${year.padStart(4, '0')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ùˆ Ø¯Ù‚ÛŒÙ‚Ù‡
    appointments
      .filter(a => a.date === filterDate)
      .sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
      })
      .forEach(a => {
        const p = patients.find(p => p.id === a.patientId);
        const div = document.createElement("div");
        div.className = "appointment-entry";
        div.innerHTML = `
          <span><strong>${p?.name || "Ù†Ø§Ù…Ø´Ø®Øµ"}</strong></span>
          <span>${a.service} | ${a.price} ØªÙˆÙ…Ø§Ù† | ${a.method}</span>
          <span>${a.time}</span>
          <button onclick="editAppointment(${a.id})">âœï¸</button>
          <button class="danger" onclick="deleteAppointment(${a.id})">ğŸ—‘</button>
        `;
        list.appendChild(div);
      });
  }

  // ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÙˆØ¨Øª
  function editAppointment(id) {
    const a = appointments.find(x => x.id === id);
    if (!a) return;

    const service = prompt("Ù†Ø§Ù… Ø³Ø±ÙˆÛŒØ³ØŸ", a.service);
    if (!service) return alert("Ù†Ø§Ù… Ø³Ø±ÙˆÛŒØ³ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");

    const price = prompt("Ù‚ÛŒÙ…ØªØŸ", a.price);
    if (!price || isNaN(price)) return alert("Ù‚ÛŒÙ…Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");

    const year = prompt("Ø³Ø§Ù„ (Ø´Ù…Ø³ÛŒ)ØŸ", a.date.split("-")[0]);
    const month = prompt("Ù…Ø§Ù‡ (Ø´Ù…Ø³ÛŒ)ØŸ", a.date.split("-")[1]);
    const day = prompt("Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ)ØŸ", a.date.split("-")[2]);
    if (!year || !month || !day) return alert("ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");

    const date = `${year.padStart(4,'0')}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;

    const time = prompt("Ø³Ø§Ø¹ØªØŸ (Ù…Ø«Ù„Ø§Ù‹ 14:30)", a.time);
    if (!time) return alert("Ø³Ø§Ø¹Øª ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");

    const methodInput = prompt("Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®ØªØŸ (1. Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†ØŒ 2. Ù†Ù‚Ø¯ÛŒØŒ 3. Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª)", a.method === "Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†" ? "1" : a.method === "Ù†Ù‚Ø¯ÛŒ" ? "2" : "3");
    let methodStr = "";
    if (methodInput === "1") methodStr = "Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†";
    else if (methodInput === "2") methodStr = "Ù†Ù‚Ø¯ÛŒ";
    else if (methodInput === "3") methodStr = "Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª";
    else return alert("Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");

    a.service = service;
    a.price = price;
    a.date = date;
    a.time = time;
    a.method = methodStr;

    saveData();
    showAppointments();
  }

  // Ø­Ø°Ù Ù†ÙˆØ¨Øª
  function deleteAppointment(id) {
    appointments = appointments.filter(a => a.id !== id);
    saveData();
    showAppointments();
  }

  // Ø±Ù†Ø¯Ø± Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ø¨Ø®Ø´ Ø¢Ù…Ø§Ø± Ùˆ Ù…Ø§Ù„ÛŒ
  function renderStatsPatients() {
    const list = document.getElementById("statsPatients");
    const search = document.getElementById("statsSearch").value.trim();
    list.innerHTML = "";
    patients.filter(p => p.name.includes(search)).forEach(p => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${p.id}"> ${p.name}`;
      list.appendChild(label);
    });
  }

  function toggleAllPatients(checkbox) {
    document.querySelectorAll("#statsPatients input[type=checkbox]").forEach(cb => cb.checked = checkbox.checked);
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ù…Ø§Ù„ÛŒ
  function calculateStats() {
    const yearFrom = document.getElementById("fromYear").value.trim();
    const monthFrom = document.getElementById("fromMonth").value.trim();
    const dayFrom = document.getElementById("fromDay").value.trim();
    const yearTo = document.getElementById("toYear").value.trim();
    const monthTo = document.getElementById("toMonth").value.trim();
    const dayTo = document.getElementById("toDay").value.trim();

    if (!yearFrom || !monthFrom || !dayFrom || !yearTo || !monthTo || !dayTo) {
      alert("Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
      return;
    }

    const from = `${yearFrom.padStart(4, '0')}-${monthFrom.padStart(2, '0')}-${dayFrom.padStart(2, '0')}`;
    const to = `${yearTo.padStart(4, '0')}-${monthTo.padStart(2, '0')}-${dayTo.padStart(2, '0')}`;

    const selectedIds = Array.from(document.querySelectorAll("#statsPatients input:checked")).map(cb => +cb.value);
    if (selectedIds.length === 0) {
      alert("Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¨ÛŒÙ…Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
      return;
    }

    const result = { "Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†": 0, "Ù†Ù‚Ø¯ÛŒ": 0, "Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª": 0 };
    appointments.forEach(a => {
      if (a.date >= from && a.date <= to && selectedIds.includes(a.patientId)) {
        result[a.method] += Number(a.price);
      }
    });

    document.getElementById("results").innerHTML = `
      <p>Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†: ${result["Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†"]} ØªÙˆÙ…Ø§Ù†</p>
      <p>Ù†Ù‚Ø¯ÛŒ: ${result["Ù†Ù‚Ø¯ÛŒ"]} ØªÙˆÙ…Ø§Ù†</p>
      <p>Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª: ${result["Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª"]} ØªÙˆÙ…Ø§Ù†</p>
    `;
  }

  // Ø¨Ú©Ø§Ù¾ Ú¯Ø±ÙØªÙ† Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
  function downloadBackup() {
    const data = { patients, appointments };
    const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "backup.json";
    a.click();
  }

  function uploadBackup() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = e => {
      const reader = new FileReader();
      reader.onload = () => {
        const data = JSON.parse(reader.result);
        patients = data.patients || [];
        appointments = data.appointments || [];
        saveData();
        renderPatients();
        showAppointments();
        renderStatsPatients();
      };
      reader.readAsText(e.target.files[0]);
    };
    input.click();
  }

  // Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
  function deleteAllData() {
    const pass = prompt("Ø±Ù…Ø² Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§ØªØŸ");
    if (pass !== "13910310") {
      alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");
      return;
    }
    if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    patients = [];
    appointments = [];
    saveData();
    renderPatients();
    showAppointments();
    renderStatsPatients();
  }

  // Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†
  function openExportPopup() {
    document.getElementById("exportPopup").classList.remove("hidden");
    renderExportPatients();
  }
  function closeExportPopup() {
    document.getElementById("exportPopup").classList.add("hidden");
  }

  // Ø±Ù†Ø¯Ø± Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ø¯Ø± Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø®Ø±ÙˆØ¬ÛŒ
  function renderExportPatients() {
    const list = document.getElementById("exportPatientList");
    const search = document.getElementById("exportSearch").value.trim();
    list.innerHTML = "";
    patients.filter(p => p.name.includes(search)).forEach(p => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${p.id}"> ${p.name}`;
      list.appendChild(label);
    });
  }

  function toggleAllExportPatients(checkbox) {
    document.querySelectorAll("#exportPatientList input[type=checkbox]").forEach(cb => cb.checked = checkbox.checked);
  }

  // ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ Ù…ØªÙ†ÛŒ Ù…Ø±ØªØ¨ Ø®Ø±ÙˆØ¬ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ùˆ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§
  function generateTXT() {
    const selectedIds = Array.from(document.querySelectorAll("#exportPatientList input:checked")).map(cb => +cb.value);
    if (selectedIds.length === 0) {
      alert("Ù‡ÛŒÚ† Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡");
      return;
    }

    let content = "";
    selectedIds.forEach(id => {
      const p = patients.find(p => p.id === id);
      content += `============================\n`;
      content += `Ù†Ø§Ù…: ${p.name}\n`;
      content += `Ù†Ø§Ù… Ù¾Ø¯Ø±: ${p.father}\n`;
      content += `Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§: ${p.phone} - ${p.phone2}\n`;
      content += `ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: ${p.regDate}\n`;
      content += `--- Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ ---\n`;
      const aps = appointments.filter(a => a.patientId === id);
      if (aps.length === 0) {
        content += "Ù†Ø¯Ø§Ø±Ø¯\n";
      } else {
        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ùˆ Ø¯Ù‚ÛŒÙ‚Ù‡
        aps.sort((a, b) => (a.date + " " + a.time).localeCompare(b.date + " " + b.time));
        aps.forEach(a => {
          content += `ØªØ§Ø±ÛŒØ®: ${a.date} - Ø³Ø§Ø¹Øª: ${a.time}\n`;
          content += `Ø³Ø±ÙˆÛŒØ³: ${a.service}\n`;
          content += `Ù‡Ø²ÛŒÙ†Ù‡: ${a.price} ØªÙˆÙ…Ø§Ù†\n`;
          content += `Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: ${a.method}\n`;
          content += "----------------------\n";
        });
      }
      content += "\n";
    });

    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "patients_appointments.txt";
    a.click();
  }

  // Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± ØµÙØ­Ù‡: Ø±Ù†Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
  window.onload = () => {
    renderPatients();
    showAppointments();
    renderStatsPatients();

// ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´ÙØ±Ø¶ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² (Ø³Ø§Ù„ØŒ Ù…Ø§Ù‡ØŒ Ø±ÙˆØ²) Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ Ø´Ù…Ø³ÛŒ
    const today = new Date();

    // ØªÙˆ Ø§ÛŒÙ†Ø¬Ø§ Ú†ÙˆÙ† Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒÙ… Ø§Ø² Ú©ÛŒØª ØªØ§Ø±ÛŒØ® Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒÙ…ØŒ ÛŒÚ© ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ Ø³Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³ÛŒÙ…
    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù¾ÛŒØ´ÙØ±Ø¶ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    function toJalaali(gy, gm, gd) {
      // Ú©Ø¯ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø² Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
      // Ú†ÙˆÙ† Ú©Ø¯ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ù‡Ø³ØªØŒ Ø§ÛŒÙ†Ø¬Ø§ ØªØ§Ø¨Ø¹ÛŒ Ø³Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ÛŒØ§ Ø§Ø² Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¬Ø¯Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†ÛŒÙ…
      // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ… ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´ÙØ±Ø¶ Ø±Ø§ Ø«Ø§Ø¨Øª Ø¨Ú¯Ø°Ø§Ø±ÛŒÙ… (Ù…Ø«Ù„Ø§Ù‹ 1404-04-21)
      return { jy: 1404, jm: 4, jd: 21 };
    }

    const jDate = toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
    document.getElementById("searchDateYear").value = jDate.jy;
    document.getElementById("searchDateMonth").value = String(jDate.jm).padStart(2, "0");
    document.getElementById("searchDateDay").value = String(jDate.jd).padStart(2, "0");
  };
</script>
</body>
</html>




